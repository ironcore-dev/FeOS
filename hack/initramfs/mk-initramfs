#!/bin/bash

set -e

FEOS_CONFIG=${1:-default}

thisDir=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
TARGET_DIR=${TARGET_DIR:-$thisDir/../../target}
ROOTFS_DIR=${thisDir}/../../target/rootfs

[ ! -d "${TARGET_DIR}" ] && echo "Directory: '$TARGET_DIR' does not exist." && exit 1

source utils.sh
source ../kernel/config.sh

pushd $ROOTFS_DIR 
echo "Create initramfs folder structure"
mkdir -pv {etc,var,lib64,lib,run,tmp} usr/{bin,lib,sbin,local} lib/x86_64-linux-gnu usr/lib/x86_64-linux-gnu usr/local/ssl

mkdir -pv {proc,dev,sys}

cat <<EOF >>etc/hosts
127.0.0.1    localhost
127.0.1.1    feos
::1          localhost feos
EOF

echo "feos" > etc/hostname

cat <<EOF >>etc/resolv.conf
nameserver 2001:4860:4860::6464
EOF

echo "Install libraries for FeOS (copy from host)"
install_libs $ROOTFS_DIR/bin/feos
cp -ra /etc/ssl/certs usr/local/ssl/

echo "Create initramfs.zst"
find . -print0 | cpio --create --format=newc --null | zstd -3 > "${TARGET_DIR}/initramfs.zst"

popd
